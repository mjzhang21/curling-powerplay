---
title: ""
author: "Mark Zhang"
date: last-modified
format:
  pdf:
    colorlinks: true
    linkcolor: blue
    number-sections: true
    geometry: margin=1in
    fontsize: 11pt
---

## Data Preprocessing

Import the data.
```{python}
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd

df_games = pd.read_csv("../data/mxd_games.csv")
df_shots = pd.read_csv(
    "../data/mxd_shots.csv", 
    dtype={60: str, 64: str}
)
df_games.head()
```

Make all the columns lowercase.
```{python}
df_shots.columns = df_shots.columns.str.replace(r'[A-Z]', lambda m: m.group(0).lower(), regex=True)
df_shots.head()
```

Create a function that plots a proportional curling sheet containing circles,
back line and hogline.
```{python}
def plot_curling_sheet():
    """
    Plots a simple curling sheet with house circles only.
    """
    # Sheet coordinates and house radii
    CENTER_X, BUTTON_Y, BACK_Y, HOG_Y = 150, 160, 40, 580
    radii = [120, 80, 40, 10]  # house circles

    fig, ax = plt.subplots(figsize=(4, 8))

    # Draw sheet lines
    ax.axvline(CENTER_X, linestyle='--', linewidth=1)
    ax.axhline(BUTTON_Y, linestyle='--', linewidth=1)
    ax.axhline(BACK_Y, linewidth=1)
    ax.axhline(HOG_Y, linewidth=1)

    # Draw house circles
    for r in radii:
        ax.add_patch(plt.Circle((CENTER_X, BUTTON_Y), r, fill=False, color='black'))

    # Formatting
    ax.set_aspect('equal')
    ax.set_xlim(0, 300)
    ax.set_ylim(0, 600)
    ax.set_title('Curling Sheet')
    ax.set_xlabel('X')
    ax.set_ylabel('Y')

    return ax

```

```{python}
df = df_shots[df_shots['left_pp'] == 1]

for shot_val in range(1, 11, 2):
    subset = df[df['shot'] == shot_val]

    if subset.empty:
        continue

    plot_curling_sheet()
    plt.scatter(subset['shooterx'], subset['shootery'],
                alpha=0.4, s=60, label=f'Shot {shot_val} (left_pp)')
    plt.legend()
    plt.title(f'Shot {shot_val} — left_pp')
    plt.show()

```

```{python}
plot_curling_sheet()
plt.scatter(subset['shooterx'], subset['shootery'],
            alpha=0.4, s=60, label=f'Shot {shot_val} (left_pp)')
plt.legend()
plt.title(f'Shot {shot_val} — left_pp')
plt.show()
```
```{python}
# df = df[df['shootery'] >= 40]
```

```{python}
df = df[df['shot'].isin([1,3,5,7,9])]
```

```{python}


df_vec = (
    df
    .pivot(
        index=["id","game","end"],  
        columns="shot",
        values=["shooterx", "shootery"]
    )
)

df_vec.columns = [f"shot{shot}_{coord}" for coord, shot in df_vec.columns]
df_vec = df_vec.reset_index()
```

```{python}
df_vec
```


```{python}
feature_cols = [c for c in df_vec.columns if "shot" in c]
df_vec = df_vec.dropna(subset=feature_cols).copy()
X = df_vec[feature_cols].values
print(X.shape)
```

```{python}
from sklearn.preprocessing import StandardScaler

scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)
```


```{python}
import umap
import hdbscan

# learn nonlinear embedding
umap_cluster = umap.UMAP(
    n_neighbors=30,
    min_dist=0.05,
    n_components=2,  
    metric="euclidean",
    random_state=42
)

X_umap = umap_cluster.fit_transform(X_scaled)

# cluster in embedding space
clusterer = hdbscan.HDBSCAN(
    min_cluster_size=15,
    min_samples=3
)

labels = clusterer.fit_predict(X_umap)
df_vec["cluster"] = labels
df_vec["cluster"].value_counts().sort_index()
```

```{python}
import numpy as np
import matplotlib.pyplot as plt

unique_labels = np.unique(labels)

plt.figure(figsize=(6,5))

sc = plt.scatter(
    X_umap[:,0],
    X_umap[:,1],
    c=labels.astype(int),
    cmap="tab10",
    s=25,
    alpha=0.7
)

cbar = plt.colorbar(sc)
cbar.set_label("Cluster")


cbar.set_ticks(unique_labels)

# optional: nicer labels (rename -1 to Noise)
tick_labels = ["Noise" if lab == -1 else str(lab) for lab in unique_labels]
cbar.set_ticklabels(tick_labels)

plt.title("UMAP + HDBSCAN")
plt.tight_layout()
plt.show()


```



